removeStrategy:
  rbac: SYNC
  items: NONE
items:
- kind: pipeline
  name: downstream-artifact
  concurrentBuild: true
  definition:
    cpsFlowDefinition:
      sandbox: true
      script: |-
        def retryCount = 0
        pipeline {
            agent {
                label retryCount == 0 ? 'maven-jdk-8-spot' : 'maven-jdk-8'
            }
            environment {
                ARTIFACT_SOURCE_JOB = 'upstream-artifact'
            }
            options { 
                retry(3) 
            }
            stages {
                stage('Retry Counter') {
                    steps {
                        script {
                            retryCount += 1
                        }
                    }
                }
                stage('Copy Artifacts') {
                    steps {
                        sh 'ls -la'
                        copyArtifacts fingerprintArtifacts: true, projectName: env.ARTIFACT_SOURCE_JOB, selector: lastSuccessful()
                    }
                }
                stage('Read Artifacts') {
                    steps {
                        sh 'ls -la'
                        sh 'cat f_2'
                    }
                }
            }
        }
  description: 'This pipeline demostrate the usage of https://plugins.jenkins.io/artifact-manager-s3/ across pipelines'
  disabled: false
  displayName: downstream-artifact
  resumeBlocked: false
- kind: pipeline
  name: upstream-artifact
  concurrentBuild: true
  definition:
    cpsFlowDefinition:
      sandbox: true
      script: |-
        pipeline {
            agent {
                kubernetes {
                    retries 2
                    defaultContainer 'golang'
                    yaml '''
        apiVersion: v1
        kind: Pod
        spec:
            containers:
            - name: golang
              image: golang:1.16.5
              command:
              - sleep
              args:
              - 99d
            - name: busybox
              image: busybox
              command:
              - cat
              tty: true
        '''
                }
            }
            stages {
                stage('Golang') {
                    stages {
                        stage ('Build'){
                            steps {
                                sh '''
                                    echo "Build number ^${BUILD_NUMBER}" >> f_1
                                    go version >> f_1
                                '''
                            }
                        }
                        stage ('Archive f_1'){
                            steps {
                                archiveArtifacts artifacts: 'f_1', fingerprint: true
                            }
                        }
                    }
                }
                stage('Busybox') {
                    stages {
                        stage ("Unarchive"){
                            steps {
                                container('busybox') {
                                    dir ('unarchive'){
                                        sh 'ls -la'
                                        unarchive mapping: [f_1: 'f_1']
                                        sh 'ls -la; cat f_1; mv f_1 f_2'
                                    }
                                }
                            }
                        }
                        stage ('Build'){
                            steps {
                                container('busybox') {
                                    dir ('unarchive'){
                                        sh '/bin/busybox >> f_2'
                                    }
                                }
                            }
                        }
                        stage ('Archive f_2'){
                            steps {
                                container('busybox') {
                                    dir ('unarchive'){
                                        archiveArtifacts artifacts: 'f_2', fingerprint: true
                                    }
                                }
                            }
                        }
                        stage ('Call Downstream'){
                            steps {
                                build 'downstream-artifact'
                            }
                        }
                    }
                }
            }
        }
  disabled: false
  description: 'This pipeline demostrate the usage of https://plugins.jenkins.io/artifact-manager-s3/ in the same pipeline'
- kind: pipeline
  name: ws-cache
  concurrentBuild: true
  definition:
    cpsFlowDefinition:
      sandbox: true
      script: |-
        def retryCount = 0

        pipeline {
            agent {
                label retryCount == 0 ? 'maven-jdk-8-spot' : 'maven-jdk-8'
            }
            options { 
                retry(3)
            }
            environment {
                MAVEN_PROJECT = 'https://github.com/jglick/simple-maven-project-with-tests'
                CACHE = 'ws-cache-maven'
            }
            stages {
                stage('Retry Counter') {
                    steps {
                        script {
                            retryCount += 1
                        }
                    }
                }
                stage('Checkout') {
                    steps {
                        git env.MAVEN_PROJECT
                    }
                }
                stage('Read') {
                    steps {
                        readCache name: env.CACHE
                    }
                }
                stage('Build') {
                    steps {
                        container('maven') {
                        sh 'mvn clean package -DskipTests -Dmaven.repo.local=./maven-repo'
                        }
                    }
                }
            }
            post {
                success {
                    writeCache name: env.CACHE, includes: 'maven-repo/**'
                }
            }
        }
  description: 'This pipeline demostrate the usage of https://docs.cloudbees.com/docs/cloudbees-ci/latest/pipelines/cloudbees-cache-step'
  disabled: false
